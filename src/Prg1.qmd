---
title: "Test librairie fichier PDF"
format: html
---

## ðŸ”§ Chargement des bibliothÃ¨ques

```{python}
# 1. Installation des dÃ©pendances
# 'Accelerate' et 'bitsandbytes' pour optimiser l'utilisation du GPU
# 'pypdf' pour la manipulation des fichiers PDF
# 'Pillow' pour le traitement d'images

!pip install -q transformers accelerate bitsandbytes torch pypdf Pillow

# 'pdf2image' sert Ã  convertir des pages PDF en images
!pip install -q pdf2image

print("âœ… Installation terminÃ©e.")
```

## ðŸ”§ Importation des bibliothÃ¨ques

```{python import-libs}
# 2. Importation


import os
import json # NOUVEAU : pour manipuler les donnÃ©es JSON
from transformers import AutoTokenizer, AutoModelForCausalLM
from pypdf import PdfReader
from pdf2image import convert_from_path
from PIL import Image
import torch

print("ðŸ“¦ BibliothÃ¨ques importÃ©es avec succÃ¨s.")
```

## ðŸ”§ Chargement du fichier pdf

```{python load-file}
import os
from pypdf import PdfReader # <-- AJOUTER CETTE LIGNE

# --- CHANGEMENT DE RÃ‰PERTOIRE DE TRAVAIL ---
# DÃ©finir le chemin cible : la racine du projet
racine_projet = "/home/onyxia/work/Projet-Methodologie/" 

# Changer le rÃ©pertoire de travail vers la racine du projet
try:
    os.chdir(racine_projet)
    print(f"âœ… Nouveau rÃ©pertoire de travail dÃ©fini sur : {os.getcwd()}")
except Exception as e:
    print(f"âŒ ERREUR: Impossible de changer de rÃ©pertoire vers {racine_projet}. VÃ©rifiez le chemin. Erreur: {e}")
    # Nous continuons quand mÃªme, mais le chemin relatif pourrait Ã©chouer
    
# --- Configuration du chemin ---
fichier_pdf = "INSEE-etude118.pdf"
repertoire_entree = "input_files"
# Le chemin complet est maintenant calculÃ© Ã  partir de la racine
chemin_complet = os.path.join(repertoire_entree, fichier_pdf)

# VÃ©rification de l'existence du fichier
if not os.path.exists(chemin_complet):
    # La vÃ©rification se fait maintenant Ã  partir de /home/onyxia/work/Projet-Methodologie/
    print(f"âŒ ERREUR FATALE: Le fichier est introuvable Ã  l'emplacement '{chemin_complet}'.")
    raise FileNotFoundError("Le fichier PDF est manquant ou le chemin est incorrect. Assurez-vous que le dossier 'input_files' existe Ã  la racine du nouveau rÃ©pertoire de travail.")
else:
    print(f"âœ… Chemin de fichier vÃ©rifiÃ© : {chemin_complet}")

# --- Lecture du texte (pypdf) ---
try:
    reader = PdfReader(chemin_complet)
    num_pages = len(reader.pages)
    print(f"ðŸ“„ Document lu. Nombre de pages : {num_pages}")
except Exception as e:
    print(f"âŒ ERREUR inattendue lors de la lecture du PDF : {e}")
```

## ðŸ”§ Analyse du fichier pdf

## ðŸ’¡ Note : La simulation de l'analyse par LLM est utilisÃ©e ici. 
## En rÃ©alitÃ©, le code rÃ©el ferait appel Ã  AutoModelForCausalLM.generate.

```{python analyze-and-export}
# --- 1. Extraction du texte ---
texte_integral = ""
try:
    # On rÃ©utilise le lecteur du bloc prÃ©cÃ©dent, sinon il faudrait le re-crÃ©er
    # Assurez-vous d'exÃ©cuter tous les blocs sÃ©quentiellement.
    for page in reader.pages:
        texte_integral += page.extract_text()
    
    print(f"Extraction du texte rÃ©ussie. {len(texte_integral)} caractÃ¨res extraits.")

except NameError:
    # Gestion d'erreur au cas oÃ¹ 'reader' ne serait pas dÃ©fini (si le bloc 2 n'a pas Ã©tÃ© exÃ©cutÃ©)
    print("âŒ ERREUR: Le lecteur de PDF (reader) n'est pas dÃ©fini. ExÃ©cutez le bloc 2 d'abord.")
    raise

# --- 2. Simulation de l'analyse LLM ---

# Le ModÃ¨le de Langage (LLM) simulerait ici l'analyse du texte_integral.
# Simuler une sortie JSON structurÃ©e basÃ©e sur l'Ã©tude INSEE.
resultat_analyse_llm = {
    "source_fichier": fichier_pdf,
    "date_analyse": os.path.getmtime(chemin_complet), # Date de modification du fichier
    "pages_analysees": num_pages,
    "resume_simule": "L'Ã©tude INSEE analyse la croissance du PIB au second trimestre, mettant en Ã©vidence une lÃ©gÃ¨re accÃ©lÃ©ration des investissements privÃ©s et une dÃ©cÃ©lÃ©ration de la consommation des mÃ©nages due Ã  l'inflation.",
    "chiffres_cles": {
        "croissance_pib_q2": "0.5%",
        "investissements_prives": "+1.2%",
        "inflation_annuelle": "5.8%"
    }
}
print("âœ¨ Analyse simulÃ©e effectuÃ©e.")

# --- 3. Configuration de la Sortie ---

# 3a. DÃ©finition des chemins
repertoire_sortie = "output_files"
nom_fichier_json = fichier_pdf.replace(".pdf", "_analyse_P1.json")
chemin_sortie = os.path.join(repertoire_sortie, nom_fichier_json)

# 3b. CrÃ©ation du rÃ©pertoire de sortie s'il n'existe pas
os.makedirs(repertoire_sortie, exist_ok=True)
print(f"CrÃ©ation/vÃ©rification du rÃ©pertoire de sortie : {repertoire_sortie}/")

# --- 4. Ã‰criture du fichier JSON ---
try:
    with open(chemin_sortie, 'w', encoding='utf-8') as f:
        # Ã‰criture du dictionnaire Python sous forme de JSON formatÃ©
        json.dump(resultat_analyse_llm, f, ensure_ascii=False, indent=4)
        
    print(f"âœ… Exportation JSON rÃ©ussie. Le fichier a Ã©tÃ© dÃ©posÃ© Ã  : {chemin_sortie}")

except Exception as e:
    print(f"âŒ ERREUR lors de l'Ã©criture du fichier JSON : {e}")